(()=>{"use strict";const e=require("dotenv"),t=require("cors"),s=require("express"),a=require("sequelize"),o=new a.Sequelize("dbztechnology2","root","",{host:"localhost",dialect:"mysql",dialectOptions:{useUTC:!0},timezone:"-05:00"}),r={id:{type:a.DataTypes.INTEGER,primaryKey:!0,autoIncrement:!0}},i={createdAt:"createdAt",updatedAt:"updatedAt"},d=["motherboard","ram","cpu","powerSupply","graphicCard"],n=(e=>{class t extends a.Model{}return t.init({...r,name:{type:a.DataTypes.STRING,unique:!0,allowNull:!1},description:{type:a.DataTypes.STRING}},{...i,modelName:"role",sequelize:e}),t.beforeSync((()=>console.log("before creaing the table"))),t.afterSync((()=>console.log("before creaing the table"))),t})(o),u=(e=>{class t extends a.Model{}return t.init({...r,names:{type:a.DataTypes.STRING},document:{type:a.DataTypes.STRING,unique:!0,allowNull:!1,validate:{isNumeric:!0,isExactLength(e){if(10!==String(e).length)throw new Error("El campo numérico debe tener exactamente 10 dígitos.")}}},email:{type:a.DataTypes.STRING,unique:!0,allowNull:!1,validate:{isEmail:!0}},password:{type:a.DataTypes.STRING,allowNull:!1},retriesPassword:{type:a.DataTypes.TINYINT},timerDisableAccount:{type:a.DataTypes.DATE},state:{type:a.DataTypes.BOOLEAN,allowNull:!1}},{...i,modelName:"user",sequelize:e}),t.beforeSync((()=>console.log("before creaing the table"))),t.afterSync((()=>console.log("before creaing the table"))),t})(o),c=(e=>{class t extends a.Model{}return t.init({...r,description:{type:a.DataTypes.STRING,allowNull:!1},discountType:{type:a.DataTypes.ENUM(["Percentage","Standard"]),validate:{correctDiscount(e){if(!["Percentage","Standard"].includes(e))throw new Error(`Quote discount type must be one of ${["Percentage","Standard"].toString()}`)}}},discount:{type:a.DataTypes.FLOAT},total:{type:a.DataTypes.INTEGER,allowNull:!1},subTotal:{type:a.DataTypes.INTEGER},deliveryType:{type:a.DataTypes.ENUM(["Premium","Paid","Standard"]),allowNull:!1,validate:{correctDiscount(e){if(!["Premium","Paid","Standard"].includes(e))throw new Error(`Quote delivery type must be one of ${["Premium","Paid","Standard"].toString()}`)}}},state:{type:a.DataTypes.ENUM(["Created","Canceled","Completed"]),allowNull:!1,validate:{correctDiscount(e){if(!["Created","Canceled","Completed"].includes(e))throw new Error(`Quote state must be ${["Created","Canceled","Completed"].toString()}`)}}}},{...i,modelName:"quote",sequelize:e}),t.beforeSync((()=>console.log("before creaing the table"))),t.afterSync((()=>console.log("before creaing the table"))),t})(o),l=(e=>{class t extends a.Model{}return t.init({...r,names:{type:a.DataTypes.STRING,allowNull:!1},document:{type:a.DataTypes.STRING,unique:!0,allowNull:!1,validate:{isNumeric:!0,isExactLength(e){if(10!==String(e).length)throw new Error("El campo numérico debe tener exactamente 10 dígitos.")}}},city:{type:a.DataTypes.STRING},address:{type:a.DataTypes.STRING},phone:{type:a.DataTypes.STRING},email:{type:a.DataTypes.STRING,unique:!0,allowNull:!1,validate:{isEmail:!0}}},{...i,modelName:"customer",sequelize:e}),t.beforeSync((()=>console.log("before creaing the table"))),t.afterSync((()=>console.log("before creaing the table"))),t})(o),p=(e=>{class t extends a.Model{}return t.init({...r,name:{type:a.DataTypes.STRING,allowNull:!1},type:{type:a.DataTypes.ENUM([...d]),allowNull:!1,validate:{correctType(e){if(!d.includes(e))throw new Error(`Product type must be one of ${d.toString()}`)}}},description:{type:a.DataTypes.STRING,allowNull:!1},price:{type:a.DataTypes.FLOAT,allowNull:!1},available:{type:a.DataTypes.BOOLEAN,allowNull:!1}},{...i,modelName:"product",sequelize:e}),t.beforeSync((()=>console.log("before creaing the table"))),t.afterSync((()=>console.log("before creaing the table"))),t})(o),m=require("bcrypt");function h(e,t){let s={};if(e instanceof a.ValidationError){const{errors:t}=e;let a=[];t.forEach((e=>{const{message:t,path:s,value:o}=e,r={message:t,path:`${s} ${o}`};a.push(r)})),s={message:"SEQ_ERROR",data:a}}else{const{message:t,status:a,path:o}=e;s={message:t,status:a,path:o}}return t.status(e.status).json(s)}const y=require("jsonwebtoken"),w=async(e,t,s)=>{console.log("_____________");try{const t=await e.headers.authorization.split(" ")[1],a=await y.verify(t,"ztechnologyAPI");console.log(a);const o=await a;e.user=o,s()}catch(e){return t.status(401).json({auth:!1,message:"ERROR - Petition over non authenticated user"})}},g=(0,s.Router)();g.post("/create",(async(e,t)=>{console.log("Peticion recibida para crear",e.body);const{names:s,document:a,email:o,password:r,role:i,state:d,idRequester:c}=e.body;try{const e=await u.findOne({where:{id:c},include:[{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}]});if("USER"==e?.dataValues?.role?.dataValues?.name)throw{message:"User has no priviligies to create another user, only ADMIN can",status:400,path:`Role ${e?.dataValues?.role?.dataValues?.name}`};if((await u.findAll({where:{email:o}})).length>0)throw{message:"Email already taken",status:400,path:`Email ${o}`};{const e=await n.findAll({where:{name:i}});if(0==e.length)throw{message:"Role Does no exist",status:400,path:`Role ${i}`};const c=await m.hash(r,10);console.log(c);const l=await u.create({names:s,document:a,email:o,password:c,state:d,roleId:e[0].dataValues.id,retriesPassword:3,timerDisableAccount:(new Date).addMinutes(-20)});return t.status(200).json({success:!0,message:"User Created successfully",data:l})}}catch(e){return e.status||(e.status=405),h(e,t)}})),g.delete("/delete/:idUser",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar",e.body);let s=e.params?.idUser;const{idUserRequester:a}=e.body;try{if(!await u.findOne({where:{id:s}}))throw{message:"User with does not exist",status:403,path:`Id ${s}`};const e=await u.findOne({where:{id:a},include:[{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}]});if(console.log(e),!e)throw{message:"User with does not exist",status:403,path:`Id ${s}`};if("ADMIN"!==e?.dataValues?.role?.name)throw{message:"User non Admin can't delete other users",status:403,path:`Id ${a}`};return await u.destroy({where:{id:s}}),t.status(200).json({success:!0,message:"User deleted succesfully"})}catch(e){return e.status||(e.status=405),h(e,t)}})),g.get("/getAll",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar",e.body);try{const e=await u.findAll({attributes:{exclude:["password","retriesPassword","timerDisableAccount"]},include:[{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}]});if(!e)throw{message:"There are no user/s",status:400,path:"Users"};return t.status(200).json({success:!0,message:"List Of all current users",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),g.post("/get",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar",e.body);const{names:s,document:a,email:o,idRequired:r,state:i,roleId:d}=e.body;let c={};r&&(c.id=r),s&&(c.names=s),a&&(c.document=a),o&&(c.email=o),d&&(c.roleId=d),null!==i&&(c.state=i);try{const e=await u.findAll({attributes:{exclude:["password","retriesPassword","timerDisableAccount"]},where:{...c},include:[{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}]});if(console.log(c),!e||0==e.length)throw{message:"There are no user/s with the attributes searched",status:400,path:c};return t.status(200).json({success:!0,message:"User/s with desired search are those",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),g.post("/modify/:idUser",w,(async(e,t)=>{console.log("=-=-=--=-=-=-=-=Peticion recibida para modificar usuario",e.body);let s=e.params?.idUser,{names:a,document:o,email:r,password:i,roleId:d,state:c,idRequester:l}=e.body,p={};a&&(p.names=a),o&&(p.document=o),r&&(p.email=r),i&&(p.password=await m.hash(i||"",10)),d&&(p.roleId="ADMIN"==d?1:2),null!==c&&(p.state=c),console.log(p.roleId,l,s);try{const e=await u.findOne({where:{id:[l]},include:[{model:n,attributes:{exclude:["createdAt","updatedAt"]}}]});if(console.log("_+_+_+_+_",e,e?.dataValues?.role?.dataValues),!e)throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${l}`};if(!await u.findOne({where:{id:[s]},include:[{model:n,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state"]}}]}))throw{message:"Requested Modify User does not exists",status:400,path:`IdUserRequested ${s}`};let a,o=e?.dataValues?.role?.dataValues?.name;if("ADMIN"==o)return"true"==p.state&&(p.timerDisableAccount=(new Date).addMinutes(-20),p.retriesPassword=3),console.log(p),await u.update({...p},{where:{id:s}}),t.status(200).json({success:!0,message:"User modified succesfully",data:{id:s,names:p.names,document:p.document,email:p.email,state:p.state,role:o,createdAt:e?.dataValues?.createdAt}});if(1==p.roleId)throw{message:"Users can not change their own role status, please ask to a Admin manager",status:401,path:`roleRequired ${s},IdRequester ${l}`};if(s!==l)throw{message:"Users can change information only of their own user",status:401,path:`IdRequired ${s},IdRequester ${l}`};return a=await u.update({...p},{where:{id:s}}),t.status(200).json({success:!0,message:"User modified succesfully",data:{id:s,names:p.names,document:p.document,email:p.email,state:p.state,role:o,createdAt:e?.dataValues?.createdAt}})}catch(e){return e.status||(e.status=405),h(e,t)}}));const f=g,b=(0,s.Router)();b.post("/login",(async(e,t)=>{const s=parseInt("120");console.log("Peticion recibida",e.body,s,typeof s,"120");const{email:a,password:o}=e.body,r=new Date;try{if(!a&&!o)throw{message:"Email and password not present",status:400,path:`Email ${a},Password ${o}`};const e=await u.findOne({where:{email:a},include:[{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}]});if(!e)throw{message:"User Email does not exists",status:400,path:`Email ${a}`};if(r<e?.dataValues?.timerDisableAccount||0==e?.dataValues?.state)throw{message:`User is banned for ${parseInt(r.minutesDiff(e?.dataValues?.timerDisableAccount))} minutes, please wait or contact your admin`,status:400,path:`StateUser ${e?.dataValues?.state},RetriesPassword ${e?.dataValues?.retriesPassword}`};m.compare(o,e?.dataValues?.password).then((async a=>{if(!a){if(1==e?.dataValues?.retriesPassword){const t=r.addMinutes(s);throw await u.update({state:!1,timerDisableAccount:t,retriesPassword:3},{where:{id:e?.dataValues?.id}}),{message:`User has been banned for ${s} minutes. Please wait or contact your ADMIN`,status:401,path:"RetriesPasswordLeft 0"}}throw await u.update({retriesPassword:e?.dataValues?.retriesPassword-1},{where:{id:e?.dataValues?.id}}),{message:`Invalid - Incorrect password, only ${e?.dataValues?.retriesPassword-1} tries left`,status:401,path:"Password"}}console.log(e?.dataValues?.state,e?.dataValues?.retriesPassword);const o=y.sign({userId:e.dataValues.id,useremail:e.dataValues.email},"ztechnologyAPI",{expiresIn:"2d"}),{id:i,names:d,document:n,email:c,state:l,roleId:p,role:m,createdAt:h}=e.dataValues;return u.update({state:!0,timerDisableAccount:r.addMinutes(-20),retriesPassword:3},{where:{id:e?.dataValues?.id}}),t.status(200).json({success:!0,message:"Login Succeess",token:o,data:{user:{id:i,names:d,document:n,email:c,state:l,role:m?.name,createdAt:h}}})})).catch((e=>(e.status||(e.status=405),h(e,t))))}catch(e){return console.log("______________________________",e),e.status||(e.status=405),h(e,t)}}));const _=b,A=(0,s.Router)();A.post("/create",w,(async(e,t)=>{console.log("______Peticion recibida para crear",e.body);const{names:s,document:a,email:o,city:r,address:i,phone:d,idRequester:n}=e.body;try{if(!await u.findOne({where:{id:[n]}}))throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${n}`};const e=await l.create({names:s,document:a,email:o,city:r,address:i,phone:d,userId:n});return t.status(200).json({success:!0,message:"Customer Created successfully",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),A.delete("/delete/:idCustomer",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar",e.body);let s=e.params?.idCustomer;try{if(!await l.findOne({where:{id:s}}))throw{message:"Requested Customer to delete does not exists",status:400,path:`IdCustomerRequested ${s}`};return await l.destroy({where:{id:s}}),t.status(200).json({success:!0,message:"Customer deleted succesfully"})}catch(e){return e.status||(e.status=405),h(e,t)}})),A.get("/getAll",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar",e.body);try{const e=await l.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state","createdAt","roleId","updatedAt"]}}]});if(!e)throw{message:"There are no customer/s",status:400,path:"Customers"};return t.status(200).json({success:!0,message:"List Of all current customer/s",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),A.post("/get",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar",e.body);const{names:s,document:a,email:o,city:r,address:i,phone:d,idRequired:n,userId:c}=e.body;let p={};n&&(p.id=n),s&&(p.names=s),a&&(p.document=a),o&&(p.email=o),r&&(p.city=r),i&&(p.address=i),d&&(p.phone=d),c&&(p.userId=c);try{const e=await l.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state"]}}],where:{...p}});if(console.log(JSON.stringify(p)),!e||0==e.length)throw{message:"There are no Customer/s with the attributes",status:400,path:p};return t.status(200).json({success:!0,message:"Customer/s with desired search are those",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),A.post("/modify/:idCustomer",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar");let s=e.params?.idCustomer;const{names:a,document:o,email:r,city:i,address:d,phone:n}=e.body;let u={};a&&(u.names=a),o&&(u.document=o),r&&(u.email=r),i&&(u.city=i),d&&(u.address=d),n&&(u.phone=n);try{if((await l.findAll({where:{id:s}})).length<=0)throw{message:"Requested Modify Customer does not exist",status:400,path:`IdCustomerRequested ${s}`};const e=await l.update({...u},{where:{id:s}});return console.log(e.length),t.status(200).json({success:!0,message:"Customer modified succesfully"})}catch(e){return console.log(e),e.status||(e.status=405),h(e,t)}}));const T=A,R=(0,s.Router)();R.post("/create",w,(async(e,t)=>{console.log("______Peticion recibida para crear",e.body);const{name:s,type:a,description:o,price:r,counterProduct:i,idRequester:d}=e.body;try{if(!await u.findOne({where:{id:[d]}}))throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${d}`};let e;if(console.log(s,a,o,r,i,d),0==i)e=await p.create({name:s,type:a,description:o,price:r,available:!1,userId:d});else if(1==i)e=await p.create({name:s,type:a,description:o,price:r,available:!0,userId:d});else if(i>1){let t=[];for(let e=0;e<i;e++)t.push({name:s,description:o,price:r,type:a,available:!0});e=await p.bulkCreate(t)}return t.status(200).json({success:!0,message:"Product Created successfully",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),R.delete("/delete/:idProduct",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar producto",e.body);let s=e.params?.idProduct;try{if(!await p.findOne({where:{id:s}}))throw{message:"Requested Product to delete does not exists",status:400,path:`IdProductRequested ${s}`};return await p.destroy({where:{id:s}}),t.status(200).json({success:!0,message:"Product deleted succesfully"})}catch(e){return e.status||(e.status=405),h(e,t)}})),R.get("/getAll",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar",e.body);try{const e=await p.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state","createdAt","updatedAt"]}}]});if(!e)throw{message:"There are no product/s",status:400,path:"Products"};return t.status(200).json({success:!0,message:"List Of all current product/s",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),R.post("/get",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar",e.body);const{name:s,type:a,description:o,price:r,available:i,idRequired:d}=e.body;let n={};d&&(n.id=d),s&&(n.name=s),a&&(n.type=a),r&&(n.price=r),o&&(n.description=o),i&&(n.available=i);try{const e=await p.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state","createdAt","updatedAt"]}}],where:{...n}});if(console.log(JSON.stringify(n)),!e||0==e.length)throw{message:"There are no Product/s with the attributes",status:400,path:n};return t.status(200).json({success:!0,message:"Product/s with desired search are those",data:customer})}catch(e){return e.status||(e.status=405),h(e,t)}})),R.post("/modify/:idProduct",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar prodicto",e.body);let s=parseInt(e.params?.idProduct),{name:a,description:o,price:r,type:i,counterProduct:d,idsAssociated:n,idRequester:u}=e.body;console.log(a,o,r,i,d,n,s);try{const e=await p.findOne({where:{id:s}});if(!e||e.length<=0)throw{message:"Requested Modify Product does not exist",status:400,path:`IdProductRequested ${s}`};if(-1==d)return console.log(n),await p.destroy({where:{id:n}}),t.status(200).json({success:!0,message:"Product modified succesfully"});if(d==n.length)return await p.update({name:a,description:o,price:r,type:i,available:!0},{where:{id:n}}),t.status(200).json({success:!0,message:"Product/s modified succesfully"});if(0==d){let e=[...n];return console.log(e,e.indexOf(s)),-1!=e.indexOf(s)&&e.splice(e.indexOf(s),1),console.log(e,e.indexOf(s)),await p.update({name:a,description:o,price:r,type:i,available:!1},{where:{id:s}}),await p.destroy({where:{id:e}}),t.status(200).json({success:!0,message:"Product/s modified succesfully"})}if(d<n.length){console.log(n);let e=[...n];console.log(e,e.indexOf(s)),-1!=e.indexOf(s)&&e.splice(e.indexOf(s),1);let u=e.splice(0,--d),c=e;return console.log(c,u,s),await p.update({name:a,description:o,price:r,type:i,available:!0},{where:{id:[...u,s]}}),await p.destroy({where:{id:c}}),t.status(200).json({success:!0,message:"Product/s modified succesfully"})}if(d>n.length){let e=d-n.length,s=[];console.log(n,e);for(let t=0;t<e;t++)s.push({name:a,description:o,price:r,type:i,available:!0,userId:u});return console.log(s),await p.update({name:a,description:o,price:r,type:i,available:!0},{where:{id:n}}),await p.bulkCreate(s),t.status(200).json({success:!0,message:"Product/s modified and created succesfully"})}throw{message:"Problem not specified, please contact your ADMIN",status:400,path:`IdProductRequested ${s}`}}catch(e){return console.log(e),e.status||(e.status=405),h(e,t)}}));const P=R,I=(0,s.Router)();I.post("/create",w,(async(e,t)=>{console.log("|||||||||||||||| CREAREMOS QUOTE",e.body);const{id:s,description:o,discountType:r,discount:i,total:d,subTotal:n,deliveryType:m,state:y,products:w,idUserRequester:g,emailCustomerRequester:f}=e.body;try{const e=await u.findOne({where:{id:[g]}});if(!e)throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${g}`};const h=await l.findOne({where:{email:[f]}});if(!h)throw{message:"Requester Customer does not exists",status:400,path:`EmailUserCustomer ${f}`};const b=await p.findAll({where:{id:{[a.Op.in]:w}}});if(console.log(b.length,w.length,e,h),b.length!==w.length)throw{message:"Required products for Quote no exist",status:400,path:`IdProductsRequired ${w.toString()}`};{const u=await c.create({id:s,description:o,discountType:r,discount:i,total:d,subTotal:n,deliveryType:m,state:y,customerId:h.dataValues.id,userId:e.dataValues.id}),l=await p.update({available:!1},{where:{id:{[a.Op.in]:w}}}),g=await p.findAll({where:{id:{[a.Op.in]:w}}});return console.log(l,g),g.map((e=>{u.addProduct(e)})),console.log(u),t.status(200).json({success:!0,message:"Quote Created successfully",data:u})}}catch(e){return e.status||(e.status=405),h(e,t)}})),I.delete("/delete/:idQuote",w,(async(e,t)=>{console.log("=====_____Peticion recibida para eliminar",e.body);let s=e.params?.idQuote;const{idUserRequester:o}=e.body;try{if(!await u.findOne({where:{id:[o]}}))throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${o}`};const e=await c.findOne({where:{id:s},include:[{model:p,attributes:{exclude:["createdAt","updatedAt","products_quotes"]}}]});if(!e)throw{message:"Requested Quote to delete does not exists",status:400,path:`IdQuoteRequested ${s}`};console.log(e);const r=await e.getProducts(),i=[];return r.map((e=>{i.push(e.dataValues.id)})),console.log(i),await p.update({available:!0},{where:{id:{[a.Op.in]:i}}}),await c.destroy({where:{id:s}}),t.status(200).json({success:!0,message:"Quote deleted succesfully"})}catch(e){return e.status||(e.status=405),h(e,t)}})),I.get("/getAll",w,(async(e,t)=>{console.log("|||||||| GET ALL QUOTES",e.body);try{const e=await c.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state","createdAt","updatedAt"]},include:{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}},{model:l,attributes:{exclude:["createdAt","updatedAt","userId"]}},{model:p,attributes:{exclude:["createdAt","updatedAt","products_quotes"]}}]});if(!e)throw{message:"There are no quote/s",status:400,path:"Quotes"};return t.status(200).json({success:!0,message:"List Of all current quote/s",data:e})}catch(e){return console.log(e),e.status||(e.status=405),h(e,t)}})),I.post("/get",w,(async(e,t)=>{console.log("=====_____get quote",e.body);const{id:s,description:a,discountType:o,discount:r,deliveryType:i,state:d,idUserRequester:m}=e.body;let y={};o&&(y.discountType=o),r&&(y.discount=r),i&&(y.deliveryType=i),d&&(y.state=d),null!==m&&(y.userId=m);try{const e=await c.findAll({include:[{model:u,attributes:{exclude:["password","retriesPassword","timerDisableAccount","state","createdAt","updatedAt"]},include:{model:n,attributes:{exclude:["createdAt","updatedAt","id"]}}},{model:l,attributes:{exclude:["createdAt","updatedAt","userId"]}},{model:p,attributes:{exclude:["createdAt","updatedAt","products_quotes"]}}],where:{...y}});if(console.log(JSON.stringify(y)),!e||0==e.length)throw{message:"There are no Quote/s with the attributes",status:400,path:y};return t.status(200).json({success:!0,message:"Quote/s with desired search are those",data:e})}catch(e){return e.status||(e.status=405),h(e,t)}})),I.post("/modify/:idQuote",w,(async(e,t)=>{console.log("=====_____Peticion recibida para modificar",e.body);const{id:s,description:o,discountType:r,discount:i,total:d,subTotal:n,deliveryType:m,state:y,products:w,idUserRequester:g,emailCustomerRequester:f}=e.body;let b=e.params?.idQuote,_={};s&&(_.id=s),o&&(_.description=o),r&&(_.discountType=r),i&&(_.discount=i),null!==d&&(_.total=d),null!==n&&(_.subTotal=n),m&&(_.deliveryType=m),y&&(_.state=y);try{if(!await u.findOne({where:{id:[g]}}))throw{message:"Requester User does not exists",status:400,path:`IdUserRequester ${g}`};const e=await l.findOne({where:{email:[f]}});if(!e)throw{message:"Requester Customer does not exists",status:400,path:`EmailUserCustomer ${f}`};const s=await c.findOne({where:{id:[b]}});if(!s)throw{message:"Requester Quote does not exists",status:400,path:`idQuote ${b}`};const o=await p.findAll({where:{id:{[a.Op.in]:w}}});if(o.length!==w.length)throw{message:"Required products for Quote no exist",status:400,path:`IdProductsRequired ${w.toString()}`};const r=o.reduce(((e,t)=>(e.push(t.dataValues.id),e)),[]),i=await s.getProducts(),d=i.reduce(((e,t)=>(e.push(t.dataValues.id),e)),[]);if(console.log("\\\\\\\\\\\\\\\\\\\\eeeee",i,w,d),w.length<d.length){const e=[...w,...d].filter((e=>-1===w.indexOf(e)||-1===d.indexOf(e))),t=i.reduce(((t,s)=>(e.includes(s.dataValues.id)||t.push(s),t)),[]);console.log(e,t,d),i.map((async e=>{await s.removeProduct(e)})),await p.update({available:!0},{where:{id:{[a.Op.in]:e}}}),t.map((async e=>{await s.addProduct(e)})),await s.save(),console.log(s)}else w.length>d.length?(console.log("Product modified succesfully",d,r),i.map((async e=>{await s.removeProduct(e)})),await p.update({available:!1},{where:{id:{[a.Op.in]:r}}}),s.addProducts(o),await s.save()):"Canceled"==y&&(i.map((async e=>{await s.removeProduct(e)})),await p.update({available:!0},{where:{id:{[a.Op.in]:r}}}),_.description=`Quote eliminated, products were restaured as available: ${r.toString()}`,await s.save());return _.customerId=e.dataValues.id,await c.update({..._},{where:{id:b}}),t.status(200).json({success:!0,message:"Product modified succesfully"})}catch(e){return e.status||(e.status=405),h(e,t)}}));const q=I;Date.prototype.addMinutes=function(e){return this.setTime(this.getTime()+60*e*1e3),this},Date.prototype.minutesDiff=function(e){var t=(this.getTime()-e.getTime())/1e3;return t/=60,Math.abs(Math.round(t))},e.config(),function(){var e;const a="8080";(e=s()).use(s.json()),e.use(t()),e.use("/api/auth",_),e.use("/api/user",f),e.use("/api/customer",T),e.use("/api/product",P),e.use("/api/quote",q),(async()=>{try{await o.authenticate().then((async()=>{(()=>{const e=e=>({...e,onDelete:"CASCADE",onUpdate:"CASCADE"});n.hasOne(u,e({foreignKey:"roleId"})),u.belongsTo(n),u.hasMany(l,e({foreignKey:"userId"})),l.belongsTo(u),u.hasMany(p,e({foreignKey:"userId"})),p.belongsTo(u),p.belongsToMany(c,e({through:"products_quotes"})),c.belongsToMany(p,e({through:"products_quotes"})),l.hasMany(c,e({foreignKey:"customerId"})),c.belongsTo(l),u.hasMany(c,e({foreignKey:"userId"})),c.belongsTo(u)})(),await o.sync({force:!1})})).catch((e=>{console.error(e)})),n.findOrCreate({where:{name:"ADMIN"},defaults:{name:"ADMIN",description:"Admin with priviligies over normal user"}}),n.findOrCreate({where:{name:"USER"},defaults:{name:"USER",description:"Regular user with actions with no priviligies"}}),console.log("DB connected")}catch(e){console.log(e)}})(),e.listen(a,(()=>{console.log(`App is executing on port${a}`)}))}()})();